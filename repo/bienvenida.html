<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear una Cuenta</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Usar la fuente Inter como predeterminada */
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <!-- Contenedor principal para centrar el formulario -->
    <div class="flex items-center justify-center min-h-screen px-4 py-12">
        <div class="w-full max-w-md mx-auto">
        
            <!-- Tarjeta de registro -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 md:p-10">
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Crear una cuenta</h1>
                    <p id="subtitle" class="mt-2 text-sm text-gray-600 dark:text-gray-400">Introduce tus datos para empezar.</p>
                </div>

                <!-- Contenedor para mensajes de error -->
                <div id="error-message" class="hidden mt-4 p-3 bg-red-100 dark:bg-red-900/40 text-red-700 dark:text-red-300 border border-red-400 dark:border-red-600 rounded-lg text-center text-sm"></div>
                
                <!-- Formulario de registro -->
                <form id="registro-form" class="mt-8 space-y-6">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre</label>
                        <div class="mt-1">
                            <input id="name" name="name" type="text" required
                                class="w-full px-4 py-3 text-gray-800 bg-gray-100 border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:focus:ring-blue-500 dark:focus:border-blue-500 transition duration-200"
                                placeholder="Tu nombre completo">
                        </div>
                    </div>

                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Correo electrónico</label>
                        <div class="mt-1">
                            <input id="email" name="email" type="email" autocomplete="email" required
                                class="w-full px-4 py-3 text-gray-800 bg-gray-100 border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:focus:ring-blue-500 dark:focus:border-blue-500 transition duration-200"
                                placeholder="tu@email.com">
                        </div>
                    </div>

                     <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contraseña</label>
                        <div class="mt-1">
                            <input id="password" name="password" type="password" required minlength="6"
                                class="w-full px-4 py-3 text-gray-800 bg-gray-100 border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 dark:focus:ring-blue-500 dark:focus:border-blue-500 transition duration-200"
                                placeholder="Mínimo 6 caracteres">
                        </div>
                    </div>

                    <div>
                        <button type="submit"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 ease-in-out">
                            Crear cuenta
                        </button>
                    </div>
                </form>

                <!-- Divisor "O" -->
                <div id="divider" class="mt-6 flex items-center justify-center">
                    <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                    <span class="px-3 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800">
                        O
                    </span>
                    <div class="w-full border-t border-gray-300 dark:border-gray-600"></div>
                </div>

                <!-- Botones de Social Login -->
                <div id="social-buttons" class="mt-6 grid grid-cols-1 gap-4">
                    <!-- Botón de Google -->
                    <button id="google-signin" type="button"
                        class="w-full inline-flex justify-center items-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                        <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" aria-hidden="true">
                           <path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C43.021,36.251,44,30.433,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path>
                        </svg>
                        <span>Continuar con Google</span>
                    </button>
                    <!-- Botón de Microsoft -->
                    <button id="microsoft-signin" type="button"
                        class="w-full inline-flex justify-center items-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200">
                        <svg class="w-5 h-5 mr-3" viewBox="0 0 21 21" aria-hidden="true">
                            <path fill="#F25022" d="M1 1h9v9H1z"/>
                            <path fill="#7FBA00" d="M11 1h9v9h-9z"/>
                            <path fill="#00A4EF" d="M1 11h9v9H1z"/>
                            <path fill="#FFB900" d="M11 11h9v9h-9z"/>
                        </svg>
                        <span>Continuar con Microsoft</span>
                    </button>
                </div>
                
                <!-- Enlace para Iniciar Sesión -->
                <div id="login-link" class="mt-8 text-center">
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        ¿Ya tienes una cuenta?
                        <a href="#" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300">
                            Inicia sesión
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, OAuthProvider, updateProfile, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKnJXo7QLcU7jxkhar_-WeLJNHtxXG9Bk",
            authDomain: "kluppy-duelos.firebaseapp.com",
            projectId: "kluppy-duelos",
            storageBucket: "kluppy-duelos.appspot.com",
            messagingSenderId: "221783859909",
            appId: "1:221783859909:web:504d021f4e50a11c8486ac",
            measurementId: "G-0839SL8VP6"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const form = document.getElementById('registro-form');
        const googleButton = document.getElementById('google-signin');
        const microsoftButton = document.getElementById('microsoft-signin');
        const errorMessageDiv = document.getElementById('error-message');

        function showError(message) {
            errorMessageDiv.textContent = message;
            errorMessageDiv.classList.remove('hidden');
        }
        
        function redirectToStripe(user) {
            const stripeUrl = 'https://buy.stripe.com/14k6rFdX2g4Y1Q4004';
            const emailParam = `?prefilled_email=${encodeURIComponent(user.email)}`;
            const clientRefParam = `&client_reference_id=${user.uid}`;
            
            console.log(`Redirecting to Stripe for user ${user.uid}...`);
            window.location.href = stripeUrl + emailParam + clientRefParam;
        }

        async function saveUserData(user, name) {
            const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main');
            const docSnap = await getDoc(userRef);
            if (!docSnap.exists()) {
                try {
                    await setDoc(userRef, {
                        uid: user.uid,
                        name: name || user.displayName || 'Usuario',
                        email: user.email,
                        createdAt: serverTimestamp()
                    });
                    console.log("User data saved to Firestore");
                } catch (error) {
                    console.error("Error saving user data: ", error);
                    showError("No se pudieron guardar los datos del usuario.");
                    throw error;
                }
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            errorMessageDiv.classList.add('hidden');
            const name = form.name.value;
            const email = form.email.value;
            const password = form.password.value;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                await saveUserData(userCredential.user, name);
                redirectToStripe(userCredential.user);
            } catch (error) {
                console.error("Error creating user:", error);
                if (error.code === 'auth/email-already-in-use') showError('Este correo electrónico ya está en uso.');
                else if (error.code === 'auth/weak-password') showError('La contraseña debe tener al menos 6 caracteres.');
                else showError('Ocurrió un error al crear la cuenta.');
            }
        });

        async function handleSocialSignIn(provider) {
            errorMessageDiv.classList.add('hidden');
            try {
                const result = await signInWithPopup(auth, provider);
                await saveUserData(result.user, result.user.displayName);
                redirectToStripe(result.user);
            } catch (error) {
                console.error("Error with social sign-in:", error);
                if (error.code === 'auth/popup-closed-by-user') return;
                else if (error.code === 'auth/account-exists-with-different-credential') showError('Ya existe una cuenta con este correo, pero con otro método de inicio de sesión.');
                else showError('No se pudo iniciar sesión.');
            }
        }

        googleButton.addEventListener('click', () => handleSocialSignIn(new GoogleAuthProvider()));
        microsoftButton.addEventListener('click', () => handleSocialSignIn(new OAuthProvider('microsoft.com')));
        
    </script>
</body>
</html>
