<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Módulos - Kluppy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Coolvetica', sans-serif; }
        .font-coolvetica-heavy { font-family: 'Coolvetica Heavy', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <header class="bg-gray-800/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center p-4">
            <a href="home.html" class="text-4xl font-bold tracking-wider text-white">Kluppy</a>
            
            <div class="text-2xl font-semibold text-cyan-400">Panel de Administración</div>
            
            <div class="relative">
                <button id="user-menu-button" class="flex items-center space-x-2">
                    <img id="user-avatar" class="w-8 h-8 rounded-full object-cover" src="https://placehold.co/40x40/7c3aed/ffffff?text=A" alt="Avatar de admin">
                </button>
                <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-md shadow-lg py-1">
                    <div class="px-4 py-2 text-sm text-gray-400">
                        <p class="font-semibold" id="user-display-name">Admin</p>
                        <p class="truncate" id="user-email">email@example.com</p>
                    </div>
                    <div class="border-t border-gray-700"></div>
                    <a href="home.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">🏠 Volver a la App</a>
                    <button id="logout-button" class="w-full text-left block px-4 py-2 text-sm text-red-400 hover:bg-gray-700">🚪 Cerrar sesión</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 lg:px-8 py-12">
        <div id="admin-content" class="hidden">
            <div class="text-sm text-gray-400 mb-4">
                <a href="admin.html" class="hover:underline">Admin</a> &gt;
                <span id="curso-nombre" class="font-semibold"></span>
            </div>

            <div class="flex justify-between items-center mb-8">
                <h1 class="text-4xl font-coolvetica-heavy">Módulos del Curso</h1>
                <a id="crear-modulo-btn" href="#" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg">
                    + Crear Nuevo Módulo
                </a>
            </div>
            
            <div id="modulos-container" class="space-y-4">
                </div>
        </div>

        <div id="loading-message" class="text-center py-20">
            <p class="text-2xl">Verificando permisos y cargando módulos...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración e Inicialización de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKnJXo7QLcU7jxkhar_-WeLJNHtxXG9Bk",
            authDomain: "kluppy-duelos.firebaseapp.com",
            projectId: "kluppy-duelos",
            storageBucket: "kluppy-duelos.appspot.com",
            messagingSenderId: "221783859909",
            appId: "1:221783859909:web:504d021f4e50a11c8486ac",
            measurementId: "G-0839SL8VP6"
        };
        const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- LÓGICA PRINCIPAL ---
        const adminContent = document.getElementById('admin-content');
        const loadingMessage = document.getElementById('loading-message');
        const modulosContainer = document.getElementById('modulos-container');
        const cursoNombreSpan = document.getElementById('curso-nombre');
        const crearModuloBtn = document.getElementById('crear-modulo-btn');

        // 1. OBTENER EL ID DEL CURSO DESDE LA URL
        const params = new URLSearchParams(window.location.search);
        const cursoId = params.get('curso');

        if (!cursoId) {
            loadingMessage.innerHTML = `<p class="text-red-500">Error: No se ha especificado un curso.</p>`;
        } else {
            // 2. VERIFICAR PERMISOS DE ADMIN (igual que en admin.html)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // --- 1. MOSTRAMOS LA INFORMACIÓN DEL USUARIO EN LA CABECERA ---
                    // (Asegúrate de que tu cabecera tiene elementos con estos IDs)
                    const userDisplayName = document.getElementById('user-display-name');
                    const userEmail = document.getElementById('user-email');
                    const userAvatar = document.getElementById('user-avatar');

                    if(userDisplayName) userDisplayName.textContent = user.displayName || 'Admin';
                    if(userEmail) userEmail.textContent = user.email;
                    if(userAvatar && user.photoURL) userAvatar.src = user.photoURL;


                    // --- 2. VERIFICAMOS SI EL USUARIO ES ADMIN ---
                    user.getIdTokenResult(true).then(idTokenResult => {
                        if (idTokenResult.claims.admin === true) {
                            // Si es admin, mostramos el contenido de la página
                            loadingMessage.classList.add('hidden');
                            adminContent.classList.remove('hidden');
                            cargarModulos();
                        } else {
                            // Si es un usuario normal, le avisamos y lo redirigimos
                            alert("No tienes permisos de administrador para acceder a esta página.");
                            window.location.href = 'home.html';
                        }
                    });

                } else {
                    // Si nadie ha iniciado sesión, lo redirigimos a la página de login
                    window.location.href = 'login.html';
                }
            });
        }

        async function cargarModulos() {
            try {
                // 3. OBTENER Y MOSTRAR EL NOMBRE DEL CURSO
                const cursoRef = doc(db, "cursos", cursoId);
                const cursoSnap = await getDoc(cursoRef);
                if (cursoSnap.exists()) {
                    cursoNombreSpan.textContent = cursoSnap.data().nombre;
                    // Actualizamos el enlace del botón para crear módulos
                    crearModuloBtn.href = `admin-crear-modulo.html?curso=${cursoId}`;
                }

                // 4. OBTENER Y RENDERIZAR LOS MÓDULOS
                modulosContainer.innerHTML = '';
                const modulosRef = collection(db, "cursos", cursoId, "modulos");
                const querySnapshot = await getDocs(modulosRef);

                if (querySnapshot.empty) {
                    modulosContainer.innerHTML = `<p class="text-gray-400">No hay módulos en este curso todavía.</p>`;
                    return;
                }

                querySnapshot.forEach(doc => {
                    const modulo = doc.data();
                    const moduloId = doc.id;
                    
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 rounded-lg p-4 flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <h3 class="text-xl font-bold">${modulo.nombre}</h3>
                            <p class="text-sm text-gray-400">${modulo.descripcion || ''}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <a href="admin-ejercicios.html?curso=${cursoId}&modulo=${moduloId}" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-sm">Gestionar Ejercicios</a>
                            <a href="admin-editar-modulo.html?curso=${cursoId}&modulo=${moduloId}" class="editar-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Editar</a>
                            <button data-id="${moduloId}" class="eliminar-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Eliminar</button>
                        </div>
                    `;
                    modulosContainer.appendChild(card);
                });

            } catch (error) {
                console.error("Error al cargar módulos:", error);
                modulosContainer.innerHTML = `<p class="text-red-500">Error al cargar los módulos.</p>`;
            }
        }

        // Usamos delegación de eventos para manejar todos los clics en el contenedor
        modulosContainer.addEventListener('click', async (e) => {
            // Verificamos si el clic fue en un botón de eliminar
            if (e.target.classList.contains('eliminar-btn')) {
                const moduloId = e.target.dataset.id;

                // Pedimos confirmación para evitar borrados accidentales
                if (confirm("¿Estás seguro de que quieres eliminar este módulo? Esta acción no se puede deshacer.")) {
                    try {
                        const moduloRef = doc(db, "cursos", cursoId, "modulos", moduloId);
                        await deleteDoc(moduloRef);
                        alert("Módulo eliminado con éxito.");
                        cargarModulos(); // Recargamos la lista para que desaparezca
                    } catch (error) {
                        console.error("Error al eliminar el módulo:", error);
                        alert("No se pudo eliminar el módulo.");
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Obtiene el ID del curso desde la URL actual de la página de módulos
            // (Ej: si la URL es admin-modulos.html?curso=ABCDE, cursoId será "ABCDE")
            const params = new URLSearchParams(window.location.search);
            const cursoId = params.get('curso');

            // 2. Encuentra el botón o enlace para crear un nuevo módulo
            const crearModuloBtn = document.getElementById('crear-nuevo-modulo-btn');

            if (crearModuloBtn && cursoId) {
                // 3. Asigna la URL correcta, incluyendo el ID del curso como parámetro
                crearModuloBtn.href = `admin-crear-modulo.html?curso=${cursoId}`;
            } else {
                // Opcional: Oculta el botón si por alguna razón no hay un ID de curso.
                // Esto previene que el admin haga clic en un enlace roto.
                if (crearModuloBtn) {
                    crearModuloBtn.style.display = 'none';
                }
                console.error("No se pudo configurar el enlace de 'Crear Módulo' porque falta el ID del curso en la URL de esta página.");
            }
        });
    </script>
</body>
</html>