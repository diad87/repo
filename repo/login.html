<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesión - Kluppy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> body { font-family: 'Inter', sans-serif; } </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div class="flex items-center justify-center min-h-screen px-4 py-12">
        <div class="w-full max-w-md mx-auto">
            <div id="auth-container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8 md:p-10">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKnJXo7QLcU7jxkhar_-WeLJNHtxXG9Bk",
            authDomain: "kluppy-duelos.firebaseapp.com",
            projectId: "kluppy-duelos",
            storageBucket: "kluppy-duelos.appspot.com",
            messagingSenderId: "221783859909",
            appId: "1:221783859909:web:504d021f4e50a11c8486ac",
            measurementId: "G-0839SL8VP6"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const authContainer = document.getElementById('auth-container');
        let isProcessing = false;

        const templates = {
            loading: (message) => `<div class="text-center p-8"><p class="text-lg text-gray-700 dark:text-gray-300">${message}</p></div>`,
            form: `
                <div class="text-center">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Iniciar Sesión</h1>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">¡Nos alegra verte de nuevo!</p>
                </div>
                <div id="message-container" class="hidden mt-4 p-3 rounded-lg text-center text-sm"></div>
                <form id="login-form" class="mt-8 space-y-6">
                    <div><label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Correo electrónico</label><div class="mt-1"><input id="email" type="email" autocomplete="email" required class="w-full px-4 py-3 text-gray-800 bg-gray-100 border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="tu@email.com"></div></div>
                    <div><label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contraseña</label><div class="mt-1"><input id="password" type="password" autocomplete="current-password" required class="w-full px-4 py-3 text-gray-800 bg-gray-100 border-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" placeholder="Tu contraseña"></div></div>
                    <div><button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Entrar</button></div>
                </form>
                <div class="mt-6 flex items-center justify-center"><div class="w-full border-t border-gray-300 dark:border-gray-600"></div><span class="px-3 text-sm font-medium text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-800">O</span><div class="w-full border-t border-gray-300 dark:border-gray-600"></div></div>
                <div class="mt-6 grid grid-cols-1 gap-4">
                    <button id="google-signin" type="button" class="w-full inline-flex justify-center items-center py-3 px-4 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600"><svg class="w-5 h-5 mr-3" viewBox="0 0 48 48" aria-hidden="true"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C43.021,36.251,44,30.433,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg><span>Continuar con Google</span></button>
                </div>
                <div class="mt-8 text-center"><p class="text-sm text-gray-600 dark:text-gray-400">¿No tienes una cuenta? <a href="index.html" class="font-medium text-blue-600 hover:text-blue-500 dark:text-blue-400 dark:hover:text-blue-300">Regístrate</a></p></div>`
        };

        function displayLoginForm() {
            authContainer.innerHTML = templates.form;
            const form = authContainer.querySelector('#login-form');
            const googleButton = authContainer.querySelector('#google-signin');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                // ... (la lógica del login con contraseña no cambia)
            });

            // Primero, asegúrate de importar estas dos herramientas al principio de tu script:

            // Luego, el listener del botón:
            googleButton.addEventListener('click', () => {
                const provider = new GoogleAuthProvider(); // 1. Crea el proveedor de Google

                // 2. Llama a la función de Firebase para mostrar el popup
                signInWithPopup(auth, provider)
                    .then((result) => {
                        // El inicio de sesión fue exitoso.
                        console.log("✅ Usuario ha iniciado sesión con Google:", result.user);
                        // La lógica de onAuthStateChanged se encargará de redirigir a home.html automáticamente.
                        // Si guardas datos del usuario en Firestore, este es un buen lugar para llamar a esa función.
                    })
                    .catch((error) => {
                        // Manejo de errores (ej. el usuario cerró el popup)
                        console.error("❌ Error durante el inicio de sesión con Google:", error);
                    });
            });
        }
        
        // --- PROCESAMIENTO CENTRAL ---
        
        authContainer.innerHTML = templates.loading('Verificando sesión...');

        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');

        if (token) {
            // Si la URL tiene un token, lo usamos para iniciar sesión
            signInWithCustomToken(auth, token)
                .then(() => {
                    // Limpia la URL y deja que onAuthStateChanged redirija
                    window.history.replaceState({}, document.title, "/login.html");
                })
                .catch(err => {
                    console.error("Error con el token personalizado:", err);
                    displayLoginForm();
                });
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Si hay un usuario (por token o sesión previa), lo mandamos a home
                window.location.href = 'home.html';
            } else if (!token) {
                // Solo mostramos el form si no hay usuario Y no estamos esperando un token
                displayLoginForm();
            }
        });
    </script>
</body>
</html>
