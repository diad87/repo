<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ejercicio de Mecanograf√≠a - Kluppy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @font-face {
            font-family: 'Coolvetica';
            src: url('fonts/coolvetica-rg-webfont.woff2') format('woff2'),
                 url('fonts/coolvetica-rg-webfont.woff') format('woff');
            font-weight: 400; font-style: normal;
        }
        @font-face {
            font-family: 'Coolvetica Heavy';
            src: url('fonts/coolvetica-heavy-webfont.woff2') format('woff2'),
                 url('fonts/coolvetica-heavy-webfont.woff') format('woff');
            font-weight: 900; font-style: normal;
        }
        body { 
            font-family: 'Coolvetica', sans-serif; 
            background-color: #1f2937; /* bg-gray-800 */
            color: #f3f4f6; /* text-gray-100 */
        }
        .font-coolvetica-heavy { font-family: 'Coolvetica Heavy', sans-serif; }
        
        /* --- ESTILOS DEL EJERCICIO --- */
        #test-mecanografia { max-width: 1000px; margin: auto; text-align: center; }
        #sample-container {
            position: relative; overflow: hidden; white-space: nowrap;
            width: 100%; margin-bottom: 2rem; background-color: #111827;
            padding: 1.5rem; border-radius: 0.75rem; border: 1px solid #374151;
        }
        #texto-muestra {
            display: inline-block; font-size: 2rem; line-height: 1.2;
            user-select: none; transition: transform 0.2s ease-out; color: #d1d5db;
        }
        #progress-container {
            position: relative; width: 100%; height: 20px;
            background: #374151; margin-bottom: 2.5rem; border-radius: 9999px; overflow: hidden;
        }
        #progress-bar { width: 0%; height: 100%; background-color: #10b981; transition: width 0.2s; }
        #progress-text {
             position: absolute; top: 0; left: 0; width: 100%; height: 100%;
             display: flex; align-items: center; justify-content: center; color: #111827; font-weight: bold;
        }
        #entrada-usuario { position: absolute; width: 1px; height: 1px; opacity: 0; left: -9999px; }
        #keyboard-container { position: relative; display: inline-block; padding: 1rem; background-color: #111827; border-radius: 0.75rem; border: 1px solid #374151; width: 100%;}
        /* 1. Definimos un estado "atenuado" para el contenedor del teclado */
        #keyboard-container.foco-activo .key {
        opacity: 0.4; /* Reducimos la opacidad de TODAS las teclas */
        transition: opacity 0.3s ease-in-out; /* Transici√≥n suave */
        }

        /* 2. Hacemos que la tecla resaltada recupere su opacidad normal y destaque */
        #keyboard-container.foco-activo .key.highlight {
        opacity: 1;
        transform: scale(1.1); /* Mantenemos un ligero zoom para que destaque m√°s */
        box-shadow: 0 8px 30px rgba(255, 255, 255, 0.5);
        border-color: #fff;
        }
        .keyboard-row { 
            margin: 6px 0; 
            display: flex;
            justify-content: center; 
            gap: 6px; 
        }
        .key {
            height: 55px;
            flex-grow: 1;
            flex-basis: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 3px solid rgba(0,0,0,0.4);
            border-radius: 8px;
            background-color: #374151;
            color: #d1d5db;
            font-size: 1rem;
            user-select: none;
            position: relative;
            transition: all 0.1s ease;
        }
        
        .key[data-key-group="group-1"] { background-color: #9EF0B0; color: #1a202c;}
        .key[data-key-group="group-2"] { background-color: #9CEB7A; color: #1a202c;}
        .key[data-key-group="group-3"] { background-color: #FAED64; color: #1a202c;}
        .key[data-key-group="group-4"] { background-color: #EDB656; color: #1a202c;}
        .key[data-key-group="group-5"] { background-color: #A668C4; color: white; }
        .key[data-key-group="group-6"] { background-color: #7EC2F5; color: #1a202c;}

        .key.highlight { transform: translateY(-4px) scale(1.05); box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4); border-color: #fff; }
        .key[data-key="F"]::after, .key[data-key="J"]::after {
            content: ""; position: absolute; bottom: 6px; left: 50%;
            transform: translateX(-50%); width: 40%; height: 3px;
            background-color: rgba(0,0,0,0.4); border-radius: 2px;
        }
        .key[data-key="CAPSLOCK"].active { animation: pulseRed 1.5s infinite; }
        @keyframes pulseRed {
            0% { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; }
            50% { background-color: #f87171; box-shadow: 0 0 25px #f87171; }
            100% { background-color: #ef4444; box-shadow: 0 0 15px #ef4444; }
        }
        
        #hands-container {
            margin-top: 2rem;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
        }
        .hand-finger {
            fill: #4b5563;
            transition: fill 0.2s ease-in-out;
        }
        
        #results-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 1000;
        }
        .star { display: inline-block; opacity: 0; transform: scale(0.5); animation: starPop 0.8s forwards; }
        @keyframes starPop {
            0% { opacity: 0; transform: scale(0.5) rotate(0deg); }
            50% { opacity: 1; transform: scale(1.3) rotate(15deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        
    </style>
</head>
<body class="w-full">

    <header class="bg-gray-800/80 backdrop-blur-sm sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center p-4">
            <a href="home.html" class="text-4xl font-bold tracking-wider text-white">Kluppy</a>
            <div class="relative">
                <button id="user-menu-button" class="flex items-center space-x-2">
                    <img id="user-avatar" class="w-8 h-8 rounded-full object-cover" src="https://placehold.co/40x40/7c3aed/ffffff?text=K" alt="Avatar de usuario">
                </button>
                <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-900 rounded-md shadow-lg py-1">
                    <div class="px-4 py-2 text-sm text-gray-400">
                        <p class="font-semibold" id="user-display-name">Usuario</p>
                        <p class="truncate" id="user-email">email@example.com</p>
                    </div>
                    <div class="border-t border-gray-700"></div>
                    <a href="home.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">üè† Home</a>
                    <a href="logros.html" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">üèÜ Mis Logros</a>
                    <a href="#" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">‚öôÔ∏è Configuraci√≥n</a>
                    <button id="logout-button" class="w-full text-left block px-4 py-2 text-sm text-red-400 hover:bg-gray-700">üö™ Cerrar sesi√≥n</button>
                </div>
            </div>
        </header>

    <main id="test-mecanografia" class="container mx-auto px-4 lg:px-8 py-12">
      <div id="sample-container">
        <p id="texto-muestra"></p>
      </div>
      <div id="progress-container">
        <div id="progress-bar"></div>
        <div id="progress-text">0%</div>
      </div>
      <input type="text" id="entrada-usuario" onpaste="return false;">

      <div id="keyboard-container">
        <div id="keyboard"></div>
      </div>
      
      <div id="hands-container">
        <svg viewBox="0 0 550 200" xmlns="http://www.w3.org/2000/svg">
            <g id="left-hand" transform="translate(40, 0)">
                <rect id="finger-pinky-left" class="hand-finger" x="0" y="40" width="40" height="120" rx="20"/>
                <rect id="finger-ring-left" class="hand-finger" x="45" y="20" width="40" height="140" rx="20"/>
                <rect id="finger-middle-left" class="hand-finger" x="90" y="0" width="40" height="160" rx="20"/>
                <rect id="finger-index-left" class="hand-finger" x="135" y="20" width="40" height="140" rx="20"/>
                <rect id="finger-thumb-left" class="hand-finger" x="175" y="100" width="60" height="40" rx="20" transform="rotate(-30, 205, 120)"/>
            </g>
            <g id="right-hand" transform="translate(245, 0)">
                <rect id="finger-thumb-right" class="hand-finger" x="15" y="100" width="60" height="40" rx="20" transform="rotate(30, 45, 120)"/>
                <rect id="finger-index-right" class="hand-finger" x="75" y="20" width="40" height="140" rx="20"/>
                <rect id="finger-middle-right" class="hand-finger" x="120" y="0" width="40" height="160" rx="20"/>
                <rect id="finger-ring-right" class="hand-finger" x="165" y="20" width="40" height="140" rx="20"/>
                <rect id="finger-pinky-right" class="hand-finger" x="210" y="40" width="40" height="120" rx="20"/>
            </g>
        </svg>
      </div>

      <div id="results-modal">
        <div class="modal-content bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md text-white border border-gray-700">
            <h3 class="text-3xl font-bold mb-4 text-center">¬°Lecci√≥n Completada!</h3>
            <div id="star-rating" class="text-5xl text-center mb-6"></div>
            <div class="space-y-2 text-lg">
                <p>Tiempo: <span id="modal-tiempo" class="font-bold text-cyan-400"></span> s</p>
                <p>PPM Netas: <span id="modal-netPPM" class="font-bold text-cyan-400"></span></p>
                <p>Precisi√≥n: <span id="modal-precision" class="font-bold text-cyan-400"></span>%</p>
                <p>Errores: <span id="modal-errors" class="font-bold text-red-400"></span></p>
            </div>
            <button class="w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg" id="close-modal">Siguiente Lecci√≥n</button>
        </div>
      </div>
    </main>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- 1. CONFIGURACI√ìN DE FIREBASE Y AUTENTICACI√ìN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAKnJXo7QLcU7jxkhar_-WeLJNHtxXG9Bk",
            authDomain: "kluppy-duelos.firebaseapp.com",
            projectId: "kluppy-duelos",
            storageBucket: "kluppy-duelos.appspot.com",
            messagingSenderId: "221783859909",
            appId: "1:221783859909:web:504d021f4e50a11c8486ac",
            measurementId: "G-0839SL8VP6"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- L√ìGICA DEL MEN√ö DE USUARIO ---
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        
        userMenuButton.addEventListener('click', () => userMenuDropdown.classList.toggle('hidden'));
        document.addEventListener('click', (e) => {
            if (!userMenuButton.contains(e.target) && !userMenuDropdown.contains(e.target)) {
                userMenuDropdown.classList.add('hidden');
            }
        });
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-display-name').textContent = user.displayName || 'Usuario';
                document.getElementById('user-email').textContent = user.email;
                if (user.photoURL) document.getElementById('user-avatar').src = user.photoURL;
            } else {
                const currentUrl = window.location.href;
                const newPath = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1) + 'index.html';
                window.location.href = newPath;
            }
        });
        
        // --- 2. L√ìGICA DEL EJERCICIO DE MECANOGRAF√çA ---

        // Referencias al DOM
        const textoMuestraElement = document.getElementById('texto-muestra');
        const sampleContainer     = document.getElementById('sample-container');
        const entradaUsuario      = document.getElementById('entrada-usuario');
        const progressBar         = document.getElementById('progress-bar');
        const progressText        = document.getElementById('progress-text');
        const resultsModal        = document.getElementById('results-modal');
        const closeModal          = document.getElementById('close-modal');
        const starRating          = document.getElementById('star-rating');
        const keyboardDiv         = document.getElementById('keyboard');
        const modalTiempo         = document.getElementById('modal-tiempo');
        const modalNetPPM         = document.getElementById('modal-netPPM');
        const modalPrecision      = document.getElementById('modal-precision');
        const modalErrors         = document.getElementById('modal-errors');

        // Estado del ejercicio
        let sampleText     = [];
        let tiempoInicio   = null;
        let timerIniciado  = false;
        let lastHandUsed   = 'right'; // Para el pulgar en la barra espaciadora

        // Configuraci√≥n del teclado
        const keyLayout = [
            [{key:"¬∫",size:1,group:6,finger:"pinky-left"}, {key:"1",size:1,group:6,finger:"pinky-left"}, {key:"2",size:1,group:4,finger:"ring-left"}, {key:"3",size:1,group:3,finger:"middle-left"}, {key:"4",size:1,group:1,finger:"index-left"}, {key:"5",size:1,group:1,finger:"index-left"}, {key:"6",size:1,group:2,finger:"index-right"}, {key:"7",size:1,group:2,finger:"index-right"}, {key:"8",size:1,group:3,finger:"middle-right"}, {key:"9",size:1,group:4,finger:"ring-right"}, {key:"0",size:1,group:6,finger:"pinky-right"}, {key:"'",size:1,group:6,finger:"pinky-right"}, {key:"¬°",size:1,group:6,finger:"pinky-right"}, {key:"Backspace",label:"‚Üê",size:2,group:6,finger:"pinky-right"}],
            [{key:"Tab",size:1.5,group:6,finger:"pinky-left"}, {key:"Q",size:1,group:6,finger:"pinky-left"}, {key:"W",size:1,group:4,finger:"ring-left"}, {key:"E",size:1,group:3,finger:"middle-left"}, {key:"R",size:1,group:1,finger:"index-left"}, {key:"T",size:1,group:1,finger:"index-left"}, {key:"Y",size:1,group:2,finger:"index-right"}, {key:"U",size:1,group:2,finger:"index-right"}, {key:"I",size:1,group:3,finger:"middle-right"}, {key:"O",size:1,group:4,finger:"ring-right"}, {key:"P",size:1,group:6,finger:"pinky-right"}, {key:"`",size:1,group:6,finger:"pinky-right"}, {key:"+",size:1,group:6,finger:"pinky-right"}, {key:"\\",size:1.5,label:"",disabled:true,group:6}],
            [{key:"CapsLock",label:"Bloq May√∫s",size:1.75,group:6,finger:"pinky-left"}, {key:"A",size:1,group:6,finger:"pinky-left"}, {key:"S",size:1,group:4,finger:"ring-left"}, {key:"D",size:1,group:3,finger:"middle-left"}, {key:"F",size:1,group:1,finger:"index-left"}, {key:"G",size:1,group:1,finger:"index-left"}, {key:"H",size:1,group:2,finger:"index-right"}, {key:"J",size:1,group:2,finger:"index-right"}, {key:"K",size:1,group:3,finger:"middle-right"}, {key:"L",size:1,group:4,finger:"ring-right"}, {key:"√ë",size:1,group:6,finger:"pinky-right"}, {key:"¬¥",size:1,group:6,finger:"pinky-right"}, {key:"√á",size:1,group:6,finger:"pinky-right"}, {key:"Enter",size:1.25,group:6,finger:"pinky-right"}],
            [{key:"ShiftLeft",label:"Shift",size:1.25,group:6,finger:"pinky-left"}, {key:"<",size:1,group:6,finger:"pinky-left"}, {key:"Z",size:1,group:6,finger:"ring-left"}, {key:"X",size:1,group:4,finger:"middle-left"}, {key:"C",size:1,group:3,finger:"index-left"}, {key:"V",size:1,group:1,finger:"index-left"}, {key:"B",size:1,group:1,finger:"index-right"}, {key:"N",size:1,group:2,finger:"index-right"}, {key:"M",size:1,group:2,finger:"middle-right"}, {key:",",size:1,group:3,finger:"ring-right"}, {key:".",size:1,group:4,finger:"pinky-right"}, {key:"-",size:1,group:6,finger:"pinky-right"}, {key:"ShiftRight",label:"Shift",size:2.75,group:6,finger:"pinky-right"}],
            [{key:"CtrlLeft",label:"Ctrl",size:1.25,group:6,finger:"pinky-left"}, {key:"Win",size:1.25,group:6}, {key:"AltLeft",label:"Alt",size:1.25,group:5,finger:"thumb-left"}, {key:"Space",label:"",size:6.25,group:5,finger:"thumb"}, {key:"AltRight",label:"AltGr",size:1.25,group:5,finger:"thumb-right"}, {key:"Menu",size:1.25,group:6}, {key:"CtrlRight",label:"Ctrl",size:1.25,group:6,finger:"pinky-right"}]
        ];
        
        // --- 3. FUNCIONES PRINCIPALES DEL EJERCICIO ---

        async function fetchTextFromWebhook() {
            try {
                const resp = await fetch("https://kluppy-n8n.divk72.easypanel.host/webhook/33b5b99a-06be-47fb-aed1-c27ca7778e7b", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idioma: 'Espa√±ol' })
                });
                if (!resp.ok) throw new Error(`Error en el webhook: ${resp.statusText}`);
                const data = await resp.json();
                return data.texto || 'El texto de ejemplo no pudo cargarse. Int√©ntalo de nuevo.';
            } catch (error) {
                console.error("Error al obtener texto:", error);
                return 'Error de conexi√≥n. No se pudo cargar el texto.';
            }
        }

        async function cargarNuevoTexto() {
            const texto = await fetchTextFromWebhook();
            sampleText = texto.split('');
            textoMuestraElement.innerHTML = ''; // Limpiar contenido anterior
            sampleText.forEach(char => {
                const span = document.createElement('span');
                span.textContent = char;
                textoMuestraElement.appendChild(span);
            });
            updateHighlighting();
            updateSampleTextPosition();
        }

        function createKeyboard() {
            keyboardDiv.innerHTML = '';
            keyLayout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'keyboard-row';
                row.forEach(keyInfo => {
                    const keyData = (typeof keyInfo === 'object') ? keyInfo : { key: keyInfo };
                    const keyText = keyData.label !== undefined ? keyData.label : keyData.key;
                    const keyId = keyData.key.toUpperCase();
                    
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key';
                    keyDiv.textContent = keyText;
                    keyDiv.style.flexGrow = keyData.size || 1;
                    keyDiv.setAttribute('data-key', keyId);
                    if (keyData.disabled) keyDiv.classList.add('disabled');
                    if (keyData.group) keyDiv.setAttribute('data-key-group', `group-${keyData.group}`);
                    if (keyData.finger) keyDiv.setAttribute('data-finger', keyData.finger);
                    rowDiv.appendChild(keyDiv);
                });
                keyboardDiv.appendChild(rowDiv);
            });
        }
        
        function updateHighlighting() {
            const typedValue = entradaUsuario.value;
            const textSpans = textoMuestraElement.querySelectorAll("span");
            
            textSpans.forEach((span, index) => {
                span.style.backgroundColor = "transparent";
                span.style.color = "#d1d5db"; // Color por defecto

                if (index < typedValue.length) {
                    // Car√°cter ya tecleado
                    span.style.color = typedValue[index] === span.textContent ? "#4ade80" : "#f87171";
                } else if (index === typedValue.length) {
                    // Car√°cter actual
                    span.style.backgroundColor = "rgba(255, 255, 255, 0.2)";
                    span.style.borderRadius = "3px";
                }
            });
            updateKeyboardAndHandHighlight();
        }
        
        function getFingerForKey(char) {
            const keyData = keyLayout.flat().find(k => (k.key || k).toUpperCase() === char.toUpperCase());
            return keyData ? keyData.finger : null;
        }
        
        function getGroupForKey(char) {
            const keyData = keyLayout.flat().find(k => (k.key || k).toUpperCase() === char.toUpperCase());
            return keyData ? keyData.group : null;
        }

        function updateKeyboardAndHandHighlight() {
            // Limpiar resaltados anteriores de todas las teclas
            document.querySelectorAll(".key.highlight").forEach(key => {
                key.classList.remove("highlight");
            });

            document.querySelectorAll(".hand-finger").forEach(finger => finger.style.fill = "#4b5563");

            const currentIndex = entradaUsuario.value.length;
            
            // Si el test no ha empezado o ya termin√≥, desactivamos el foco
            if (currentIndex >= sampleText.length || sampleText.length === 0) {
                document.getElementById('keyboard-container').classList.remove('foco-activo');
                return;
            }
            
            // --- A√ëADIDO: Activamos el modo foco en el teclado ---
            document.getElementById('keyboard-container').classList.add('foco-activo');

            let nextChar = sampleText[currentIndex];
            let finger = getFingerForKey(nextChar);
            
            if (nextChar === " ") {
                finger = lastHandUsed === "left" ? "thumb-right" : "thumb-left";
            }
            
            const keySelector = `.key[data-key="${nextChar.toUpperCase() === ' ' ? 'SPACE' : nextChar.toUpperCase()}"]`;
            const keyToHighlight = document.querySelector(keySelector);
            
            if (keyToHighlight) {
                keyToHighlight.classList.add("highlight");
            }
            
            if (finger) {
                const fingerElement = document.getElementById(`finger-${finger}`);
                const keyGroup = getGroupForKey(nextChar);
                const keyWithGroup = document.querySelector(`.key[data-key-group="group-${keyGroup}"]`);
                if (fingerElement && keyWithGroup) {
                    fingerElement.style.fill = window.getComputedStyle(keyWithGroup).backgroundColor;
                }
            }
        }   
        
        function updateSampleTextPosition() {
            const textSpans = textoMuestraElement.querySelectorAll("span");
            let currentIndex = entradaUsuario.value.length;
            if (currentIndex >= textSpans.length) {
                currentIndex = textSpans.length > 0 ? textSpans.length - 1 : 0;
            }
            const currentSpan = textSpans[currentIndex];
            if (!currentSpan) return;
            
            const containerWidth = sampleContainer.clientWidth;
            const spanCenter = currentSpan.offsetLeft + currentSpan.offsetWidth / 2;
            const newTranslateX = (containerWidth / 2) - spanCenter;
            
            textoMuestraElement.style.transform = `translateX(${newTranslateX}px)`;
        }

        function calcularResultados(segundos) {
            const typedText = entradaUsuario.value;
            let errores = 0;
            sampleText.forEach((char, i) => {
                if (i < typedText.length && typedText[i] !== char) {
                    errores++;
                }
            });

            const minutos = segundos / 60;
            const netPPM = Math.max(0, Math.round((typedText.length / 5 - errores) / minutos));
            const precision = (sampleText.length - errores) / sampleText.length * 100;

            modalTiempo.textContent = segundos.toFixed(1);
            modalNetPPM.textContent = netPPM;
            modalPrecision.textContent = precision.toFixed(1);
            modalErrors.textContent = errores;
            
            let estrellas = 0;
            if (precision >= 98 && netPPM >= 50) estrellas = 3;
            else if (precision >= 95 && netPPM >= 35) estrellas = 2;
            else if (precision >= 90) estrellas = 1;

            starRating.innerHTML = Array(estrellas).fill('‚≠ê')
                .map((s, i) => `<span class="star" style="animation-delay:${i * 0.4}s">${s}</span>`).join('');
            
            resultsModal.style.display = 'flex';
        }

        async function reiniciarEjercicio() {
            resultsModal.style.display = 'none';
            entradaUsuario.value = '';
            entradaUsuario.disabled = false;
            
            timerIniciado = false;
            tiempoInicio = null;
            
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            
            // --- A√ëADIDO: Desactivamos el modo foco al reiniciar ---
            document.getElementById('keyboard-container').classList.remove('foco-activo');

            await cargarNuevoTexto();
            entradaUsuario.focus();
        }

        // --- 4. EVENT LISTENERS ---

        entradaUsuario.addEventListener('input', () => {
            // Iniciar el temporizador con la primera pulsaci√≥n
            if (!timerIniciado && entradaUsuario.value.length > 0) {
                timerIniciado = true;
                tiempoInicio = Date.now();
            }

            // Actualizar la mano usada para la barra espaciadora
            const lastChar = entradaUsuario.value.slice(-1);
            const finger = getFingerForKey(lastChar);
            if (finger?.includes("left")) lastHandUsed = "left";
            if (finger?.includes("right")) lastHandUsed = "right";
            
            // Actualizar UI
            const porcentaje = Math.min(entradaUsuario.value.length / sampleText.length * 100, 100);
            progressBar.style.width = `${porcentaje}%`;
            progressText.textContent = `${Math.round(porcentaje)}%`;
            updateHighlighting();
            updateSampleTextPosition();

            // Comprobar si se ha completado el texto
            if (entradaUsuario.value.length === sampleText.length) {
                const tiempoTranscurrido = (Date.now() - tiempoInicio) / 1000;
                entradaUsuario.disabled = true;
                timerIniciado = false;
                calcularResultados(tiempoTranscurrido);
            }
        });

        // Listener para el estado de Bloq May√∫s
        entradaUsuario.addEventListener("keydown", (event) => {
            const capsLockKey = document.querySelector('.key[data-key="CAPSLOCK"]');
            if (event.getModifierState && capsLockKey) {
                if (event.getModifierState("CapsLock")) {
                    capsLockKey.classList.add("active");
                } else {
                    capsLockKey.classList.remove("active");
                }
            }
        });

        closeModal.addEventListener('click', reiniciarEjercicio);

        // --- 5. INICIALIZACI√ìN ---
        async function init() {
            createKeyboard();
            await reiniciarEjercicio(); // Carga el texto inicial y pone el foco

            // Mantener el foco en el input
            document.body.addEventListener('click', (e) => {
                if (!e.target.closest('.modal-content') && !e.target.closest('#user-menu-button')) {
                    entradaUsuario.focus();
                }
            }, true);
        }

        init();

    </script>
</body>
</html>